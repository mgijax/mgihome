#!./python
import sys
if '.' not in sys.path:
	sys.path.insert (0, '.')

MGI_LIBS = '/usr/local/mgi/live/lib/python'
if MGI_LIBS not in sys.path:
	sys.path.insert (0, MGI_LIBS)

import Configuration
config = Configuration.get_Configuration ('Configuration', 1)

import homelib
import webshare_lib

import os
import pg_db
db = pg_db		# setup alias to minimize code changes
import string

def listToFile (str_list, filename):
    print "writing %s" % filename
    fp = open (filename, 'w')
    for item in str_list:
        fp.write ('%s\n' % item)
    fp.close()
    return

def getDbDate ():
    # Purpose: return value of latest db update
    # Returns: string
    # Assumes: nothing
    # Effects: nothing
    # Throws: db module may throw DB exceptions
    # pull the MGI:ID and geneSymbol from the database

    db.useOneConnection(1)
    db.set_sqlUser(config["DB_USER"])
    db.set_sqlPassword(config["DB_PASSWORD"])
    db.set_sqlServer(config["DB_SERVER"])
    db.set_sqlDatabase(config["DB_DATABASE"])
    cmds = [] # SQL command list
    cmds.append('''SELECT to_char(lastdump_date, 'DD Mon YYYY') as dbDate,
        	public_version 
        FROM MGI_dbInfo''')

    #  Excecute queries
    results = db.sql(cmds, 'auto')
    db.useOneConnection(0)
    dbDateInfo = results[0][0]

    return dbDateInfo["dbDate"]

def getCreDriver ():
    # Purpose: return value of latest db update
    # Returns: string
    # Assumes: nothing
    # Effects: nothing
    # Throws: db module may throw DB exceptions
    # pull the MGI:ID and geneSymbol from the database

    # 03/13/2013	lec (scrum-dog/TR11248)
    #	TR10216/Cre Driver/handle postgres case-insensitivity issue

    db.useOneConnection(1)
    db.set_sqlUser(config["DB_USER"])
    db.set_sqlPassword(config["DB_PASSWORD"])
    db.set_sqlServer(config["DB_SERVER"])
    db.set_sqlDatabase(config["DB_DATABASE"])
    
    driverDict = {}
    results = db.sql('''
	select distinct driverNote, lower(driverNote) as lowNote 
	from ALL_Cre_Cache 
	order by driverNote
	''', 'auto')
    for r in results:
	if not driverDict.has_key(r['lowNote']):
	    driverDict[r['lowNote']] = []
	    driverDict[r['lowNote']].append(r['driverNote'])
    driverList = driverDict.keys()
    driverList.sort()
    drivers = ["<option selected value='' name='default'>(choose one)</option>"] # SQL command list
    for r in driverList:
        drivers.append("<option value='%s'>%s</option>" % (driverDict[r][0], driverDict[r][0]))
    listToFile(drivers, '../www/include/driver_list.html')

  
def captchaInclude ():
    form = """<input type="hidden" name="%s" id="%s" value="default">
        <input type="text" name="%s" id="%s" value="default">""" % \
        (config['CAPTCHA_ELEMENT'], config['CAPTCHA_ELEMENT'], \
        config['CAPTCHA_HIDE'], config['CAPTCHA_HIDE'])
    js = """<script type="text/javascript" language="JavaScript"> 
            list_row = document.getElementById("%s");
	    list_row.parentNode.removeChild(list_row);
        </script>""" % config['CAPTCHA_HIDE']

        
    stringToFile (form, '../www/include/captchaform.html')
    stringToFile (js, '../www/include/captchajs.html')

def stringToFileNoNL (s, filename):
    #  Ultimately this should replace the stringToFile method
    #  for the current release being driven by an NIH Survey Janan wants
    #  out, we are only using this call for the generation of ftp_url2.html.
    #  This change was authorized by Jill as it would require more testing
    #  to make sure there was no negative affect on all the other URLs,
    #  if all calls to stringToFile went through here.  This method
    #  does not include the NL character that is added in the call stringToFile
    #  makes to listToFile.  This newline character was causing problems in
    #  firefox with seeing the url in the page.
    print "writing %s" % filename
    fp = open (filename, 'w')
    fp.write ('%s' % s)
    fp.close()

    return


def stringToFile (s, filename):
    listToFile ( [s], filename)
    return

INCLUDEDIR = os.path.join(config['MGIHOME_PATH'], 'www/include/')

def createIncludeLink (includeName, fileLoc ) :
# 
# INPUTS: includeName - name of the soft link to be created
#         fileLoc - full path to source file
    filePath = os.path.join(INCLUDEDIR, includeName)
    if os.path.exists(filePath):
        os.system("rm " + filePath)
    os.system("ln -s " + fileLoc + " " + filePath)

def main ():
    getCreDriver()
    captchaInclude()
    stringToFile (config['WI_URL'], '../www/include/wi_url.html')
    stringToFileNoNL (config['WI_URL'], '../www/include/wi_url2.html')
    stringToFile (config['FTP_BASE_URL'], '../www/include/ftp_url.html')
    stringToFile (config['MTB_URL'], '../www/include/mtb_url.html')
    stringToFile (config['MTB_PATHOLOGY_URL'], '../www/include/mtb_pathology_url.html')
    stringToFile (config['MPD_URL'], '../www/include/mpd_url.html')
    #  This version of the ftp_url file is being generated to support a problem
    #  found in the implementation of TR7388.  The newline being written to
    #  the file after the URL was not being handled well via firefox.
    #  To minimize testing requirements Jill Lewis jlewis@informatics.jax.org
    #  authorized the generation of a second ftp_url html file.
    stringToFileNoNL (config['FTP_BASE_URL'], '../www/include/ftp_url2.html')
    stringToFile (config['MGIHOME_URL'], '../www/include/mgihome_url.html')
    stringToFileNoNL (config['MGIHOME_URL'], '../www/include/mgihome_url2.html')
    stringToFile (config['GB_URL'], '../www/include/gb_url.html')
    stringToFile (config['GBROWSE_URL'], '../www/include/gbrowse_url.html')
    stringToFile (config['JBROWSE_URL'], '../www/include/jbrowse_url.html')
    stringToFile (config['GO_GRAPH_URL'], '../www/include/gograph_url.html')
    stringToFile (config['GO_TOOLS_URL'], '../www/include/gotools_url.html')
    stringToFile (config['LOCUSLINK_URL'], \
        '../www/include/locuslink_url.html')
    stringToFile (config['RGD_URL'], \
        '../www/include/rgd_url.html')
    stringToFile (config['ENTREZ_URL'], \
        '../www/include/entrez_url.html')
    stringToFile (config['GLOSSARY_URL'], \
        '../www/include/glossary_url.html')
    stringToFileNoNL (config['USERHELP_URL'], \
        '../www/include/userhelp_url.html')
    stringToFile (config['SCHEMA'],\
        '../www/include/schema_url.html')
    stringToFile (config['NAME'],\
        '../www/include/mgiversion.html')
    stringToFile (config['FEWI_URL'], \
        '../www/include/fewi_url.html')
    stringToFile (config['JAVAWI_URL'], \
        '../www/include/java_url.html')
    stringToFileNoNL (config['FEWI_URL'], \
        '../www/include/fewi_url.html')
    stringToFile (config['QUICKSEARCH_URL'], \
        '../www/include/quicksearch_url.html')        
    stringToFile (config['WKSILVERS_URL'], \
            '../www/include/wksilvers_url.html')        
    stringToFile (config['COOKBOOK_URL'], \
            '../www/include/cookbook_url.html')        
    stringToFile (config['MORSEBOOK_URL'], \
            '../www/include/morsebook_url.html') 
    stringToFile (config['PATHWAYS_URL'], \
            '../www/include/pathways_url.html')       
    stringToFile (config['SILVER_URL'], \
            '../www/include/silverbook_url.html') 
    stringToFile (config['FRITHBOOK_URL'], \
            '../www/include/frithbook_url.html')    
    stringToFile (config['GREENBOOK_URL'], \
            '../www/include/greenbook_url.html')    
    stringToFile (config['THEILERBOOK_URL'], \
            '../www/include/theilerbook_url.html')    
    stringToFile (config['MGIWS_URL'], \
            '../www/include/mgiws_url.html')    
    stringToFileNoNL (config['WEBSHARE_URL'], \
            '../www/include/webshare_url.html')      
    stringToFile (webshare_lib.webshareLookup('mgi_logo'), \
        '../www/include/mgi_logo.html')
    stringToFile (webshare_lib.webshareLookup('help'), \
        '../www/include/help_large.html')
    stringToFile (webshare_lib.webshareLookup('jax_logo'), \
        '../www/include/jax_logo.html')
    stringToFile (webshare_lib.webshareLookup('mgi_logo_small'), \
        '../www/include/mgi_logo_small.html')
    stringToFile (webshare_lib.webshareLookup('new'), \
        '../www/include/new.html')
    stringToFile (config['WEBSHARE_URL'] + 'css/' + config['MGIHOME_CSS_FILE'], \
        '../www/include/stylesheet.html')
    stringToFile (config['WEBSHARE_URL'] + 'js/' + config['MGIHOME_JS_FILE'], \
        '../www/include/javascript.html')

    # new additions for KOMP

    stringToFile (config['GENBANK_HOME'],
	'../www/include/genbank_home_url.html')
    stringToFile (config['ENSEMBL_HOME'],
	'../www/include/ensembl_home_url.html')
    stringToFile (config['ENTREZGENE_HOME'],
	'../www/include/entrezgene_home_url.html')
    stringToFile (config['KOMP_HOME'],
	'../www/include/komp_home_url.html')
    stringToFile (config['KOMP_NIH'],
	'../www/include/komp_nih_url.html')
    stringToFile (config['IMSRURL'],
	'../www/include/imsr_home_url.html')

    # new include file for the faq's
    stringToFileNoNL (config['FAQ_URL'],
        '../www/include/faq_url.html')

    # new include files for apache aliased menu and homepages
    stringToFile (config['HOMEPAGES_URL'],
        '../www/include/homepages_url.html')
    stringToFile (config['MENUS_URL'],
        '../www/include/menus_url.html')

    stringToFile(getDbDate(), '../www/include/stats_date.shtml')


    #####----- Template Include Files --------#####
    createIncludeLink('templateHead.html', config['MGICONFIG_PATH'] + 'web/templateHead.html')
    createIncludeLink('templateHeadNoReset.html', config['MGICONFIG_PATH'] + 'web/templateHeadNoReset.html')
    createIncludeLink('templateBodyStart.html', config['MGICONFIG_PATH'] + 'web/templateBodyStart.html')
    createIncludeLink('templateHdpBodyStart.html', config['MGICONFIG_PATH'] + 'web/templateHdpBodyStart.html')
    createIncludeLink('templateBodyStop.html', config['MGICONFIG_PATH'] + 'web/templateBodyStop.html')

    createIncludeLink('templateBlankBodyStart.html', config['MGICONFIG_PATH'] + 'web/templateBlankBodyStart.html')
    createIncludeLink('templateBlankBodyStop.html', config['MGICONFIG_PATH'] + 'web/templateBlankBodyStop.html')

    createIncludeLink('templateHomePageBodyStart.html', config['MGICONFIG_PATH'] + 'web/templateHomePageBodyStart.html')
    createIncludeLink('templateHomePageBodyStop.html', config['MGICONFIG_PATH'] + 'web/templateHomePageBodyStop.html')


    return

if __name__ == '__main__':
    main()

